---
import "../styles/global.css";

/* =========================
   TIMEZONE URUGUAY (FIXED)
========================= */
const TZ = "America/Montevideo";
const DAY_MS = 86400000;

/* Convierte cualquier fecha ISO a día UY real (00:00 UY) */
const toUY = (iso) =>
  new Date(
    new Intl.DateTimeFormat("en-CA", {
      timeZone: TZ,
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
    }).format(new Date(iso)) + "T00:00:00-03:00",
  );

/* HOY REAL EN URUGUAY (FIX DEFINITIVO) */
const today = new Date(
  new Intl.DateTimeFormat("en-CA", {
    timeZone: TZ,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
  }).format(new Date()) + "T00:00:00-03:00",
);

/* =========================
   FETCH EVENTOS
========================= */
const response = await fetch(
  "https://base-ana-calendario.up.railway.app/api/events",
);
const json = await response.json();

const events = (json.docs || []).map((ev) => {
  const url =
    ev.url && ev.url.startsWith("http")
      ? ev.url
      : ev.url
        ? `https://${ev.url}`
        : null;

  return {
    id: ev.id,
    title: ev.title,
    start: ev.startDate,
    end: ev.endDate,
    color: ev.color,
    url,
  };
});

/* =========================
   RANGO DINÁMICO
========================= */
const lastEventDate = events.reduce((latest, ev) => {
  const end = toUY(ev.end);
  return end > latest ? end : latest;
}, today);

const TOTAL_DAYS = Math.floor((lastEventDate - today) / DAY_MS) + 1;

/* Weekdays */
const WEEKDAYS = ["dom", "lun", "mar", "mié", "jue", "vie", "sáb"];

/* =========================
   DAYS DESKTOP
========================= */
const days = Array.from({ length: TOTAL_DAYS }, (_, i) => {
  const d = new Date(today.getTime() + i * DAY_MS);
  const month = d.toLocaleString("es-ES", { month: "long", timeZone: TZ });

  return {
    day: d.getDate(),
    weekday: WEEKDAYS[d.getDay()],
    monthName: month.charAt(0).toUpperCase() + month.slice(1),
  };
});

/* =========================
   DAYS MOBILE
========================= */
const mobileDays = Array.from({ length: TOTAL_DAYS }, (_, i) => {
  const d = new Date(today.getTime() + i * DAY_MS);
  const key = d.toISOString().split("T")[0];
  const month = d.toLocaleString("es-ES", { month: "long", timeZone: TZ });

  return {
    key,
    day: d.getDate(),
    weekday: WEEKDAYS[d.getDay()],
    monthName: month.charAt(0).toUpperCase() + month.slice(1),
  };
});

/* Helpers */
const diffDays = (a, b) => Math.floor((a - b) / DAY_MS);

/* =========================
   DESKTOP – EVENTOS
========================= */
const sortedEvents = [...events].sort(
  (a, b) => new Date(a.start) - new Date(b.start),
);

const rows = [];

function getRow(start, end) {
  for (let i = 0; i < rows.length; i++) {
    if (start > rows[i]) {
      rows[i] = end;
      return i + 3;
    }
  }
  rows.push(end);
  return rows.length + 2;
}

/* =========================
   MOBILE – EVENTOS POR DÍA
========================= */
const eventsByDay = {};

events.forEach((ev) => {
  const start = toUY(ev.start);
  const end = toUY(ev.end);

  for (let d = new Date(start); d <= end; d = new Date(d.getTime() + DAY_MS)) {
    const key = d.toISOString().split("T")[0];
    if (!eventsByDay[key]) eventsByDay[key] = [];
    eventsByDay[key].push(ev);
  }
});

/* =========================
   COLORES
========================= */
function getTextColor(bgColor) {
  if (!bgColor) return "#111";

  const hex = bgColor.replace("#", "");
  const r = parseInt(hex.slice(0, 2), 16);
  const g = parseInt(hex.slice(2, 4), 16);
  const b = parseInt(hex.slice(4, 6), 16);

  const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
  return luminance > 0.6 ? "#111" : "#fff";
}
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calendario</title>
  </head>

  <body class="bg-neutral-100 text-neutral-900">
    <main class="max-w-[1400px] mx-auto px-4 md:px-10 py-12">
      <h1 class="text-[28px] font-semibold mb-6 font-[PPEditorialNew]">
        Calendario
      </h1>

      <!-- =========================
           MOBILE
      ========================== -->
      <div class="block md:hidden space-y-10">
        {
          mobileDays.map((d, i) => {
            const dayEvents = eventsByDay[d.key] || [];
            const prev = mobileDays[i - 1];
            const showMonth = !prev || prev.monthName !== d.monthName;

            return (
              <section class="space-y-3">
                {showMonth && (
                  <div class="pt-6 pb-2">
                    <p class="text-[20px] font-semibold font-[PPEditorialNew]">
                      {d.monthName}
                    </p>
                    <div class="h-px bg-neutral-300 mt-2" />
                  </div>
                )}

                <div class="flex items-baseline gap-4">
                  <span class="text-[36px] font-[PPEditorialNew]">{d.day}</span>
                  <span class="italic text-neutral-500">{d.weekday}</span>
                </div>

                <div class="space-y-2">
                  {dayEvents.map((ev) => {
                    const bg = ev.color;
                    const text = getTextColor(bg);

                    return (
                      <a
                        href={ev.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="block rounded-2xl px-4 py-3 transition hover:opacity-90"
                        style={`background-color:${bg};color:${text};`}
                      >
                        <p class="font-[PPEditorialNew] text-[15px]">
                          {ev.title}
                        </p>
                      </a>
                    );
                  })}

                  {dayEvents.length === 0 && (
                    <div class="h-px bg-neutral-200" />
                  )}
                </div>
              </section>
            );
          })
        }
      </div>

      <!-- =========================
           DESKTOP
      ========================== -->
      <div class="hidden md:block">
        <div
          id="monthLabel"
          class="sticky top-0 z-30 bg-neutral-100 py-4
                 text-[22px] font-semibold tracking-wide
                 font-[PPEditorialNew]"
        >
          {days[0].monthName}
        </div>

        <div id="timeline" class="overflow-x-auto min-h-[420px]">
          <div
            class="grid gap-x-14 gap-y-5 items-start"
            style={`grid-template-columns: repeat(${days.length}, 180px);`}
          >
            {
              days.map((d) => (
                <div
                  class="day-col text-center text-[18px] italic text-neutral-500
                       font-[PPEditorialNew]"
                  data-month={d.monthName}
                >
                  {d.weekday}
                </div>
              ))
            }

            {
              days.map((d) => (
                <div
                  class="text-center text-[20px] font-normal pb-3
                       border-b border-neutral-300
                       font-[PPEditorialNew]"
                >
                  {d.day}
                </div>
              ))
            }

            {
              sortedEvents.map((ev) => {
                const start = toUY(ev.start);
                const end = toUY(ev.end);

                const startOffset = diffDays(start, today);
                const endOffset = diffDays(end, today);

                if (endOffset < 0 || startOffset > TOTAL_DAYS - 1) return null;

                const colStart = Math.max(1, startOffset + 1);
                const colEnd = Math.min(TOTAL_DAYS, endOffset + 1);
                const span = colEnd - colStart + 1;

                const row = getRow(startOffset, endOffset);
                const bg = ev.color;
                const text = getTextColor(bg);

                return (
                  <div
                    class="relative h-16"
                    style={`grid-column:${colStart}/span ${span};grid-row:${row};`}
                  >
                    <div
                      class="absolute inset-0 rounded-2xl"
                      style={`background-color:${bg};`}
                    />

                    <a
                      href={ev.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="sticky left-0 z-10 h-full inline-flex items-center
                             px-5 rounded-2xl whitespace-nowrap
                             font-[PPEditorialNew] transition hover:opacity-90"
                      style={`background-color:${bg};color:${text};`}
                    >
                      <span class="text-[15px] font-normal">{ev.title}</span>
                    </a>
                  </div>
                );
              })
            }
          </div>
        </div>
      </div>
    </main>

    <!-- =========================
         MES DINÁMICO
    ========================== -->
    <script>
      const timeline = document.getElementById("timeline");
      const monthLabel = document.getElementById("monthLabel");
      const dayCols = document.querySelectorAll(".day-col");

      const columnWidth = 180 + 56;

      timeline?.addEventListener("scroll", () => {
        const index = Math.floor(timeline.scrollLeft / columnWidth);
        const day = dayCols[index];
        if (!day) return;

        const month = day.dataset.month;
        if (monthLabel.textContent !== month) {
          monthLabel.textContent = month;
        }
      });
    </script>
  </body>
</html>
