---
export const prerender = false;

import "../styles/global.css";

/* =========================
   TIMEZONE URUGUAY (FIXED)
========================= */
const TZ = "America/Montevideo";
const DAY_MS = 86400000;

/* =========================
   CONFIGURACIÃ“N DE TRUNCAMIENTO
========================= */
const MAX_TITLE_LENGTH = 25; // Cambiar este nÃºmero para ajustar cuÃ¡ntos caracteres mÃ¡ximo

/* FunciÃ³n para truncar texto */
const truncateText = (text, maxLength) => {
  if (!text) return "";
  if (text.length > maxLength) {
    return text.substring(0, maxLength) + "...";
  }
  return text;
};

/* Convierte cualquier fecha ISO a dÃ­a UY real (00:00 UY) */
const toUY = (iso) =>
  new Date(
    new Intl.DateTimeFormat("en-CA", {
      timeZone: TZ,
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
    }).format(new Date(iso)) + "T00:00:00-03:00",
  );

/* HOY REAL EN URUGUAY */
const today = new Date(
  new Intl.DateTimeFormat("en-CA", {
    timeZone: TZ,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
  }).format(new Date()) + "T00:00:00-03:00",
);

/* =========================
   FETCH EVENTOS
========================= */
const response = await fetch(
  "https://base-ana-calendario.up.railway.app/api/events?limit=1000",
);
const json = await response.json();

const events = (json.docs || []).map((ev) => {
  const url =
    ev.url && ev.url.startsWith("http")
      ? ev.url
      : ev.url
        ? `https://${ev.url}`
        : null;

  return {
    id: ev.id,
    title: ev.title,
    start: ev.startDate,
    end: ev.endDate,
    description: ev.description || "",
    image: ev.imageneURL || null, // ðŸ‘ˆ ESTE ERA EL PROBLEMA
    tags: ev.tags?.map((t) => t.tag) || [],
    color: ev.color,
    url,
  };
});

/* =========================
   RANGO DINÃMICO
========================= */
const lastEventDate = events.reduce((latest, ev) => {
  const end = toUY(ev.end);
  return end > latest ? end : latest;
}, today);

const TOTAL_DAYS = Math.floor((lastEventDate - today) / DAY_MS) + 1;

/* Weekdays */
const WEEKDAYS = ["dom", "lun", "mar", "miÃ©", "jue", "vie", "sÃ¡b"];

/* =========================
   DAYS DESKTOP
========================= */
const days = Array.from({ length: TOTAL_DAYS }, (_, i) => {
  const d = new Date(today.getTime() + i * DAY_MS);
  const month = d.toLocaleString("es-ES", { month: "long", timeZone: TZ });

  return {
    day: d.getDate(),
    weekday: WEEKDAYS[d.getDay()],
    monthName: month.charAt(0).toUpperCase() + month.slice(1),
  };
});

/* =========================
   DAYS MOBILE
========================= */
const mobileDays = Array.from({ length: TOTAL_DAYS }, (_, i) => {
  const d = new Date(today.getTime() + i * DAY_MS);
  const key = d.toISOString().split("T")[0];
  const month = d.toLocaleString("es-ES", { month: "long", timeZone: TZ });

  return {
    key,
    day: d.getDate(),
    weekday: WEEKDAYS[d.getDay()],
    monthName: month.charAt(0).toUpperCase() + month.slice(1),
  };
});

/* Helpers */
const diffDays = (a, b) => Math.floor((a - b) / DAY_MS);

/* =========================
   DESKTOP â€“ EVENTOS
========================= */
const sortedEvents = [...events].sort(
  (a, b) => new Date(a.start) - new Date(b.start),
);

const rows = [];

function getRow(start, end) {
  for (let i = 0; i < rows.length; i++) {
    if (start > rows[i]) {
      rows[i] = end;
      return i + 3;
    }
  }
  rows.push(end);
  return rows.length + 2;
}

/* =========================
   MOBILE â€“ EVENTOS POR DÃA
========================= */
const eventsByDay = {};

events.forEach((ev) => {
  const start = toUY(ev.start);
  const end = toUY(ev.end);

  for (let d = new Date(start); d <= end; d = new Date(d.getTime() + DAY_MS)) {
    const key = d.toISOString().split("T")[0];
    if (!eventsByDay[key]) eventsByDay[key] = [];
    eventsByDay[key].push(ev);
  }
});

/* =========================
   COLORES
========================= */
function getTextColor(bgColor) {
  if (!bgColor) return "#111";

  const hex = bgColor.replace("#", "");
  const r = parseInt(hex.slice(0, 2), 16);
  const g = parseInt(hex.slice(2, 4), 16);
  const b = parseInt(hex.slice(4, 6), 16);

  const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
  return luminance > 0.6 ? "#111" : "#fff";
}
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calendario</title>
  </head>

  <body class="bg-neutral-100 text-neutral-900">
    <main class="max-w-[1400px] mx-auto px-4 md:px-10 py-12">
      <h1 class="text-[28px] font-semibold mb-6 font-[PPEditorialNew]">
        Calendario
      </h1>

      <!-- =========================
           MOBILE
      ========================== -->
      <div class="block md:hidden space-y-10">
        {
          mobileDays.map((d, i) => {
            const dayEvents = eventsByDay[d.key] || [];
            const prev = mobileDays[i - 1];
            const showMonth = !prev || prev.monthName !== d.monthName;

            return (
              <section class="space-y-3">
                {showMonth && (
                  <div class="pt-6 pb-2">
                    <p class="text-[20px] font-semibold font-[PPEditorialNew]">
                      {d.monthName}
                    </p>
                    <div class="h-px bg-neutral-300 mt-2" />
                  </div>
                )}

                <div class="flex items-baseline gap-4">
                  <span class="text-[36px] font-[PPEditorialNew]">{d.day}</span>
                  <span class="italic text-neutral-500">{d.weekday}</span>
                </div>

                <div class="space-y-2">
                  {dayEvents.map((ev) => {
                    const bg = ev.color;
                    const text = getTextColor(bg);

                    return (
                      <a
                        href="#"
                        data-title={ev.title}
                        data-start={ev.start}
                        data-end={ev.end}
                        data-description={ev.description}
                        data-image={ev.image}
                        data-tags={ev.tags.join(",")}
                        data-url={ev.url}
                        data-color={bg}
                        class="event-link block rounded-2xl px-4 py-3 transition hover:opacity-90"
                        style={`background-color:${bg};color:${text};`}
                      >
                        <p class="font-[PPEditorialNew] text-[15px]">
                          {truncateText(ev.title, MAX_TITLE_LENGTH)}
                        </p>
                      </a>
                    );
                  })}

                  {dayEvents.length === 0 && (
                    <div class="h-px bg-neutral-200" />
                  )}
                </div>
              </section>
            );
          })
        }
      </div>

      <!-- =========================
           DESKTOP
      ========================== -->
      <div class="hidden md:block">
        <div
          id="monthLabel"
          class="sticky top-0 z-30 bg-neutral-100 py-4
                 text-[22px] font-semibold tracking-wide
                 font-[PPEditorialNew]"
        >
          {days[0].monthName}
        </div>

        <div id="timeline" class="overflow-x-auto min-h-[420px]">
          <div
            class="grid gap-x-14 gap-y-5 items-start"
            style={`grid-template-columns: repeat(${days.length}, 180px);`}
          >
            {
              days.map((d) => (
                <div
                  class="day-col text-center text-[18px] italic text-neutral-500
                       font-[PPEditorialNew]"
                  data-month={d.monthName}
                >
                  {d.weekday}
                </div>
              ))
            }

            {
              days.map((d) => (
                <div
                  class="text-center text-[20px] font-normal pb-3
                       border-b border-neutral-300
                       font-[PPEditorialNew]"
                >
                  {d.day}
                </div>
              ))
            }

            {
              sortedEvents.map((ev) => {
                const start = toUY(ev.start);
                const end = toUY(ev.end);

                const startOffset = diffDays(start, today);
                const endOffset = diffDays(end, today);

                if (endOffset < 0 || startOffset > TOTAL_DAYS - 1) return null;

                const colStart = Math.max(1, startOffset + 1);
                const colEnd = Math.min(TOTAL_DAYS, endOffset + 1);
                const span = colEnd - colStart + 1;

                const row = getRow(startOffset, endOffset);
                const bg = ev.color;
                const text = getTextColor(bg);

                return (
                  <div
                    class="relative h-16"
                    style={`grid-column:${colStart}/span ${span};grid-row:${row};`}
                  >
                    <div
                      class="absolute inset-0 rounded-2xl"
                      style={`background-color:${bg};`}
                    />

                    <a
                      href="#"
                      data-title={ev.title}
                      data-start={ev.start}
                      data-end={ev.end}
                      data-description={ev.description}
                      data-image={ev.image}
                      data-tags={ev.tags.join(",")}
                      data-url={ev.url}
                      data-color={bg}
                      class="event-link sticky left-0 z-10 h-full inline-flex items-center
         px-5 rounded-2xl whitespace-nowrap
         font-[PPEditorialNew] transition hover:opacity-90"
                      style={`background-color:${bg};color:${text};`}
                    >
                      <span class="text-[15px] font-normal">
                        {truncateText(ev.title, MAX_TITLE_LENGTH)}
                      </span>
                    </a>
                  </div>
                );
              })
            }
          </div>
        </div>
      </div>
    </main>
    <!-- =========================
     LOTTIE INTRO DESKTOP
========================= -->
    <div
      id="lottieIntro"
      class="fixed inset-0 z-[40]
         hidden md:flex
         items-center justify-center
         pointer-events-none"
    >
      <div id="lottieContainer" class="w-[240px] h-[240px]"></div>
    </div>

    <!-- =========================
     POPUP EVENTO (RESPONSIVE PRO)
========================= -->
    <!-- =========================
     POPUP EVENTO (RESPONSIVE PRO)
========================= -->
    <div
      id="eventPopup"
      class="fixed inset-0 z-50 bg-black/40
         hidden items-center justify-center"
    >
      <div
        class="bg-white w-full md:max-w-4xl
           max-h-[92vh] overflow-y-auto
           rounded-t-3xl md:rounded-3xl
           relative
           md:grid md:grid-cols-[42%_58%]"
      >
        <!-- Cerrar -->
        <button
          id="closePopup"
          class="absolute top-4 right-4 z-20
             w-10 h-10 rounded-full
             bg-white/80 backdrop-blur
             flex items-center justify-center
             text-lg"
        >
          âœ•
        </button>

        <!-- IMAGEN -->

        <div
          class="relative w-full
         aspect-[4/3]
         md:aspect-auto
         max-h-[38vh] md:max-h-none
         bg-neutral-100 overflow-hidden
         md:rounded-l-3xl"
        >
          <img
            id="popupImage"
            class="w-full h-full object-cover cursor-zoom-in"
            alt=""
            loading="lazy"
          />
        </div>

        <!-- CONTENIDO -->
        <div class="px-6 py-7 space-y-4 md:space-y-5">
          <h2
            id="popupTitle"
            class="text-[22px] md:text-[24px]
               leading-tight font-[PPEditorialNew]"
          >
          </h2>

          <p id="popupDates" class="text-sm text-neutral-500"></p>

          <div id="popupTags" class="flex flex-wrap gap-2"></div>

          <p
            id="popupDesc"
            class="text-[15px] leading-relaxed text-neutral-800"
          >
          </p>

          <!-- BOTÃ“N VER MÃS -->
          <a
            id="popupLink"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2
               px-5 py-3 mt-2
               rounded-full
               text-sm font-medium
               border border-neutral-300
               transition
               hover:bg-neutral-900 hover:text-white
               hover:border-neutral-900"
          >
            Ver mÃ¡s
            <span class="text-lg leading-none">â†’</span>
          </a>
        </div>
      </div>
    </div>
    <!-- =========================
     MODAL IMAGEN FULLSCREEN
========================= -->
    <div
      id="imageModal"
      class="fixed inset-0 z-[60] hidden bg-black/90
         flex items-center justify-center"
    >
      <img
        id="imageModalImg"
        class="max-w-full max-h-full object-contain"
        alt=""
      />

      <button
        id="closeImageModal"
        class="absolute top-4 right-4
           w-10 h-10 rounded-full
           bg-white/90 text-black
           flex items-center justify-center text-lg"
      >
        âœ•
      </button>
    </div>

    <!-- =========================
         JS POPUP + MES DINÃMICO
    ========================== -->
    <script>
      const popup = document.getElementById("eventPopup");
      const closeBtn = document.getElementById("closePopup");

      const titleEl = document.getElementById("popupTitle");
      const datesEl = document.getElementById("popupDates");
      const descEl = document.getElementById("popupDesc");
      const imgEl = document.getElementById("popupImage");
      const tagsEl = document.getElementById("popupTags");
      const linkEl = document.getElementById("popupLink");
      const imageModal = document.getElementById("imageModal");
      const imageModalImg = document.getElementById("imageModalImg");
      const closeImageModal = document.getElementById("closeImageModal");

      const FALLBACK_IMAGE = "/img/imgblanca3.png";

      document.addEventListener("click", (e) => {
        const link = e.target.closest(".event-link");
        if (!link) return;

        e.preventDefault();

        titleEl.textContent = link.dataset.title;
        titleEl.style.color = link.dataset.color;

        const start = new Date(link.dataset.start);
        const end = new Date(link.dataset.end);

        datesEl.textContent =
          start.toLocaleDateString("es-UY") +
          (end ? " â€“ " + end.toLocaleDateString("es-UY") : "");

        descEl.textContent = link.dataset.description || "";

        // Tags
        tagsEl.innerHTML = "";
        (link.dataset.tags || "")
          .split(",")
          .filter(Boolean)
          .forEach((t) => {
            const span = document.createElement("span");
            span.className = "px-3 py-1 text-xs rounded-full bg-neutral-200";
            span.textContent = t;
            tagsEl.appendChild(span);
          });

        // Imagen con fallback
        const imageContainer = imgEl.closest("div");
        imgEl.src = link.dataset.image || FALLBACK_IMAGE;
        imgEl.onerror = () => {
          imgEl.src = FALLBACK_IMAGE;
          imageContainer.style.backgroundColor = link.dataset.color;
        };

        // Si no hay imagen, aplicar color de fondo
        if (!link.dataset.image) {
          imageContainer.style.backgroundColor = link.dataset.color;
        } else {
          imageContainer.style.backgroundColor = "";
        }

        // Link
        if (link.dataset.url) {
          linkEl.href = link.dataset.url;
          linkEl.classList.remove("hidden");
        } else {
          linkEl.classList.add("hidden");
        }

        popup.classList.remove("hidden");
        popup.classList.add("flex");
        document.body.style.overflow = "hidden";
      });

      closeBtn.onclick = () => {
        popup.classList.add("hidden");
        popup.classList.remove("flex");
        document.body.style.overflow = "";
      };

      popup.onclick = (e) => {
        if (e.target === popup) {
          popup.classList.add("hidden");
          popup.classList.remove("flex");
          document.body.style.overflow = "";
        }
      };

      imgEl.addEventListener("click", () => {
        if (!imgEl.src) return;
        imageModalImg.src = imgEl.src;
        imageModal.classList.remove("hidden");
      });
      closeImageModal.onclick = () => {
        imageModal.classList.add("hidden");
        imageModalImg.src = "";
      };

      imageModal.onclick = (e) => {
        if (e.target === imageModal) {
          imageModal.classList.add("hidden");
          imageModalImg.src = "";
        }
      };

      // Actualizar mes dinÃ¡mico al hacer scroll
      const monthLabel = document.getElementById("monthLabel");
      const timeline = document.getElementById("timeline");
      const dayCols = document.querySelectorAll(".day-col");

      timeline.addEventListener("scroll", () => {
        if (dayCols.length === 0) return;

        // Encontrar la primera columna visible
        const timelineRect = timeline.getBoundingClientRect();
        let visibleMonth = null;

        dayCols.forEach((col) => {
          const colRect = col.getBoundingClientRect();
          // Si estÃ¡ en el viewport
          if (
            colRect.left < timelineRect.right &&
            colRect.right > timelineRect.left
          ) {
            if (!visibleMonth) {
              visibleMonth = col.dataset.month;
            }
          }
        });

        if (visibleMonth && monthLabel) {
          monthLabel.textContent = visibleMonth;
        }
      });

      // Drag para arrastrar el timeline
      let isDown = false;
      let startX;
      let scrollLeft;

      timeline.addEventListener("mousedown", (e) => {
        isDown = true;
        startX = e.pageX - timeline.offsetLeft;
        scrollLeft = timeline.scrollLeft;
        timeline.style.cursor = "grabbing";
      });

      timeline.addEventListener("mouseleave", () => {
        isDown = false;
        timeline.style.cursor = "auto";
      });

      timeline.addEventListener("mouseup", () => {
        isDown = false;
        timeline.style.cursor = "auto";
      });

      timeline.addEventListener("mousemove", (e) => {
        if (!isDown) return;
        e.preventDefault();
        const x = e.pageX - timeline.offsetLeft;
        const walk = (x - startX) * 1; // Multiplicar por 1 para velocidad normal
        timeline.scrollLeft = scrollLeft - walk;
      });

      // Scroll con rueda del mouse (wheel event)
      timeline.addEventListener("wheel", (e) => {
        // Solo si hay contenido que scrollear horizontalmente
        if (timeline.scrollWidth > timeline.clientWidth) {
          e.preventDefault();
          // deltaY positivo = scroll hacia abajo, lo convertimos a scroll derecha
          // deltaY negativo = scroll hacia arriba, lo convertimos a scroll izquierda
          timeline.scrollLeft += e.deltaY;
        }
      }, { passive: false });

      /* =========================
   LOTTIE INTRO DESKTOP
========================= */
      const lottieIntro = document.getElementById("lottieIntro");
      const lottieContainer = document.getElementById("lottieContainer");

      // Solo desktop
      if (window.innerWidth >= 768) {
        lottieIntro.classList.remove("hidden");

        const animation = lottie.loadAnimation({
          container: lottieContainer,
          renderer: "svg",
          loop: false,
          autoplay: true,
          // ðŸ‘‡ reemplazÃ¡ por tu JSON
          path: "/intro.json",
        });

        animation.addEventListener("complete", () => {
          lottieIntro.classList.add("opacity-0");

          setTimeout(() => {
            lottieIntro.style.display = "none";
          }, 500);
        });
      }
    </script>
    <script src="https://unpkg.com/lottie-web@5.12.2/build/player/lottie.min.js"
    ></script>
  </body>
</html>
