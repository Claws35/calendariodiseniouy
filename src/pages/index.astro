---
export const prerender = false;
import "../styles/global.css";
import NavBar from "../components/NavBar.astro";
import Timeline from "../components/Timeline.astro";
import MobileView from "../components/MobileView.astro";
import EventPopup from "../components/EventPopup.astro";

/* =========================
   TIMEZONE URUGUAY (FIXED)
========================= */
const TZ = "America/Montevideo";
const DAY_MS = 86400000;

/* =========================
   CONFIGURACI√ìN DE TRUNCAMIENTO
========================= */
const MAX_TITLE_LENGTH = 25; // Cambiar este n√∫mero para ajustar cu√°ntos caracteres m√°ximo

/* Funci√≥n para truncar texto */
const truncateText = (text, maxLength) => {
  if (!text) return "";
  if (text.length > maxLength) {
    return text.substring(0, maxLength) + "...";
  }
  return text;
};

/* Convierte cualquier fecha ISO a d√≠a UY real (00:00 UY) */
const toUY = (iso) =>
  new Date(
    new Intl.DateTimeFormat("en-CA", {
      timeZone: TZ,
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
    }).format(new Date(iso)) + "T00:00:00-03:00",
  );

/* HOY REAL EN URUGUAY */
const today = new Date(
  new Intl.DateTimeFormat("en-CA", {
    timeZone: TZ,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
  }).format(new Date()) + "T00:00:00-03:00",
);

/* =========================
   FETCH EVENTOS
========================= */
const response = await fetch(
  "https://base-ana-calendario.up.railway.app/api/events?limit=1000",
);
const json = await response.json();

const events = (json.docs || []).map((ev) => {
  const url =
    ev.url && ev.url.startsWith("http")
      ? ev.url
      : ev.url
        ? `https://${ev.url}`
        : null;

  return {
    id: ev.id,
    title: ev.title,
    start: ev.startDate,
    end: ev.endDate,
    description: ev.description || "",
    image: ev.imageneURL || null, // üëà ESTE ERA EL PROBLEMA
    tags: ev.tags?.map((t) => t.tag) || [],
    color: ev.color,
    url,
  };
});

/* =========================
   RANGO DIN√ÅMICO
========================= */
const lastEventDate = events.reduce((latest, ev) => {
  const end = toUY(ev.end);
  return end > latest ? end : latest;
}, today);

const TOTAL_DAYS = Math.floor((lastEventDate - today) / DAY_MS) + 1;

/* Weekdays */
const WEEKDAYS = ["dom", "lun", "mar", "mi√©", "jue", "vie", "s√°b"];

/* =========================
   DAYS DESKTOP
========================= */
const days = Array.from({ length: TOTAL_DAYS }, (_, i) => {
  const d = new Date(today.getTime() + i * DAY_MS);
  const month = d.toLocaleString("es-ES", { month: "long", timeZone: TZ });

  return {
    day: d.getDate(),
    weekday: WEEKDAYS[d.getDay()],
    monthName: month.charAt(0).toUpperCase() + month.slice(1),
  };
});

/* =========================
   DAYS MOBILE
========================= */
const mobileDays = Array.from({ length: TOTAL_DAYS }, (_, i) => {
  const d = new Date(today.getTime() + i * DAY_MS);
  const key = d.toISOString().split("T")[0];
  const month = d.toLocaleString("es-ES", { month: "long", timeZone: TZ });

  return {
    key,
    day: d.getDate(),
    weekday: WEEKDAYS[d.getDay()],
    monthName: month.charAt(0).toUpperCase() + month.slice(1),
  };
});

/* Helpers */
const diffDays = (a, b) => Math.floor((a - b) / DAY_MS);

/* =========================
   DESKTOP ‚Äì EVENTOS
========================= */
const sortedEvents = [...events].sort(
  (a, b) => new Date(a.start) - new Date(b.start),
);

/* =========================
   MOBILE ‚Äì EVENTOS POR D√çA
========================= */
const eventsByDay = {};

events.forEach((ev) => {
  const start = toUY(ev.start);
  const end = toUY(ev.end);

  for (let d = new Date(start); d <= end; d = new Date(d.getTime() + DAY_MS)) {
    const key = d.toISOString().split("T")[0];
    if (!eventsByDay[key]) eventsByDay[key] = [];
    eventsByDay[key].push(ev);
  }
});

/* =========================
   COLORES
========================= */
function getTextColor(bgColor) {
  if (!bgColor) return "#111";

  const hex = bgColor.replace("#", "");
  const r = parseInt(hex.slice(0, 2), 16);
  const g = parseInt(hex.slice(2, 4), 16);
  const b = parseInt(hex.slice(4, 6), 16);

  const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
  return luminance > 0.6 ? "#111" : "#fff";
}

/* =========================
   GENERAR SCHEMA JSON-LD
========================= */
const eventSchemas = events
  .slice(0, 10)
  .map((ev) => ({
    "@context": "https://schema.org",
    "@type": "Event",
    name: ev.title,
    description: ev.description,
    image: ev.image || undefined,
    startDate: ev.start,
    endDate: ev.end,
    location: {
      "@type": "Place",
      name: "Uruguay",
    },
    url: ev.url || undefined,
  }))
  .filter((ev) => ev.url || ev.image);

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "Inicio",
      item: "https://arteydiseno.com.uy",
    },
    {
      "@type": "ListItem",
      position: 2,
      name: "Calendario",
      item: "https://arteydiseno.com.uy/calendario",
    },
  ],
};
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- SEO Mejorado -->
    <title>
      Calendario de eventos de dise√±o y arte en Uruguay | Agenda actualizada
    </title>
    <meta
      name="description"
      content="Calendario interactivo de eventos de dise√±o y arte en Uruguay: exposiciones de arte, dise√±o gr√°fico, arquitectura, ferias creativas y actividades art√≠sticas organizadas por fecha."
    />
    <meta
      name="keywords"
      content="eventos dise√±o arte Uruguay, calendario arte dise√±o, exposiciones arte, dise√±o gr√°fico Uruguay, arquitectura eventos, arte contempor√°neo Uruguay"
    />
    <meta name="robots" content="index, follow" />
    <meta name="language" content="es" />
    <meta name="author" content="Arte y Dise√±o Uruguay" />
    <link rel="canonical" href="https://arteydiseno.com.uy/calendario" />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta
      property="og:title"
      content="Calendario de eventos de dise√±o y arte en Uruguay"
    />
    <meta
      property="og:description"
      content="Explora nuestra agenda visual de eventos de dise√±o y arte en Uruguay. Exposiciones, ferias creativas, arquitectura y m√°s."
    />
    <meta
      property="og:image"
      content="https://arteydiseno.com.uy/og-image.jpg"
    />
    <meta property="og:url" content="https://arteydiseno.com.uy/calendario" />
    <meta property="og:site_name" content="Arte y Dise√±o Uruguay" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:title"
      content="Calendario de eventos de dise√±o y arte en Uruguay"
    />
    <meta
      name="twitter:description"
      content="Agenda actualizada de eventos de dise√±o y arte en Uruguay"
    />
    <meta
      name="twitter:image"
      content="https://arteydiseno.com.uy/og-image.jpg"
    />

    <!-- JSON-LD Schema -->
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  </head>

  <body class="bg-white text-neutral-900">
    <NavBar />
    <main class="max-w-[1400px] mx-auto px-4 md:px-10 py-0 md:pt-20">
      <!-- MOBILE VIEW -->
      <MobileView
        {mobileDays}
        {eventsByDay}
        {getTextColor}
        {truncateText}
        {MAX_TITLE_LENGTH}
      />

      <!-- DESKTOP TIMELINE -->
      <Timeline
        {days}
        {sortedEvents}
        {TOTAL_DAYS}
        {today}
        {diffDays}
        {getTextColor}
        {truncateText}
        {MAX_TITLE_LENGTH}
        {toUY}
      />
    </main>

    <!-- EVENT POPUP -->
    <EventPopup />
  </body>
</html>
